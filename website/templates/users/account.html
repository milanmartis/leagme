{% extends "base.html" %}
{% block title %}User Page{% endblock %}

{% block content %}

<br />

<div class="container readinglazy" align="center">
  <div class="row" style="display:block;max-width:320px; text-align: center;">
    <div valign="middle" align="center" class="col-12">
      <img src="{{ url_for('static', filename='img/my-account.svg') }}" width="250" class="filter-green" />

      <form method="POST" action="{{ url_for('auth.user_details') }}">
        <h3 align="center"></h3>
        <div class="form-group">
          <h1 style="margin-top:-15px;margin-bottom:15px;">
            <p style="font-size: 80%;font-weight:700;opacity:0.5;margin-bottom:0px;">
            User Id
            </p>
            {{user.email }}
          </h1>
        </div>
        <div class="form-group">
          <input
            type="hidden"
            id="useride"
            name="useride"
            value="{{user.id}}"
          />
          <input
            type="text"
            class="form-control"
            autocomplete="off"
            maxlength="10"
            id="first_name_update"
            name="first_name_update"
            placeholder="User name"
            value="{{ user.first_name }}"
          />
        </div>
        <div class="form-group">
          <input
            type="hidden"
            class="form-control"
            id="password_old"
            name="password_old"
            placeholder="Old Password"
            value=""
          />
        </div>
        <div class="form-group">
          <input
            type="hidden"
            class="form-control"
            id="password1"
            name="password1"
            placeholder="New Password"
            value=""
          />
        </div>
        <div class="form-group">
          <input
            type="hidden"
            class="form-control"
            id="password2"
            name="password2"
            placeholder="New Password (Confirm)"
            value=""
          />
        </div>
        <br />
        <button type="submit" id="account_button" class="btn-demo btn-outline-dark btn-block" onclick="javascript:spinner();document.getElementById('account_button').style.color='#00EE00';">
          SUBMIT
          <div class="loader">
            <div class="loading">
            </div>
          </div>
        </button>
      </form>
    </div>
    <div class="col-12 justify-content-center text-center">
      <br>

      <div class="col-sm-12">
        <!-- Inklúzia iných šablón -->
          {% include 'pricing.html' %}
      
          <!-- Zahrnutie šablóny platobných metód -->
          {% include 'payment.html' %}
      </div>

      <div class="col-sm-12">
        <h4 style="font-size: 80%; line-height:86%; padding:0px; margin-top:10px;">Payment history</h4>
        <div id="invoice-container">
          <p>Loading invoices...</p>
        </div>
      </div>
      <br>
      <br>
          <h6>
            <a class="btn2 nav-item nav-link" href="{{ url_for('auth.logout') }}">LOGOUT</a>
          </h6>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('Fetching Stripe data...');

    fetch('{{ url_for("auth.get_stripe_data") }}')
        .then(response => {
            console.log('Received response:', response);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);

            if (data.error) {
                document.getElementById('invoice-container').innerHTML = `<p>${data.error}</p>`;
                return;
            }

            // Render invoices
            let invoiceHTML = '';
            data.invoices.forEach(invoice => {
                console.log('Processing invoice:', invoice);
                invoiceHTML += `<table border="1" cellpadding="5" cellspacing="0"><tbody>`;
                invoice.line_items.forEach(item => {
                    console.log('Processing line item:', item);
                    invoiceHTML += `<tr class="table-row">
                                      <td style="width:34%; text-align: left; margin: 4px; padding: 8px; border-radius: 20px 0 0 20px;">
                                          ${item.description ? item.description.split('×')[1]?.split('(')[0].trim() : 'No description'}
                                      </td>
                                      <td style="width:28%; text-align:center; margin:4px; padding: 8px;">
                                          ${new Date(invoice.created * 1000).toLocaleDateString()}
                                      </td>
                                      <td style="width:28%; text-align:right; margin: 4px; padding: 8px;">
                                          ${(item.amount / 100).toFixed(2)} €
                                      </td>
                                      <td style="width:20%; text-align:center; margin-right: 8px; padding-right: 8px; border-radius: 0 20px 20px 0;">
                                          <a href="users/download_invoice/${invoice.id}" title="download invoice"><i class="fas fa-download"></i></a>
                                      </td>
                                    </tr>`;
                });
                invoiceHTML += `</tbody></table>`;
            });
            document.getElementById('invoice-container').innerHTML = invoiceHTML;
        })
        .catch(error => {
            console.error('Error loading invoices:', error);
            document.getElementById('invoice-container').innerHTML = `<p>Error loading invoices: ${error.message}</p>`;
        });
});
</script>

{% endblock %}
